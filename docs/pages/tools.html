<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>TextUtil</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- 51.la -->
    <script>
        !function(p){"use strict";!function(t){var s=window,e=document,i=p,c="".concat("https:"===e.location.protocol?"https://":"http://","sdk.51.la/js-sdk-pro.min.js"),n=e.createElement("script"),r=e.getElementsByTagName("script")[0];n.type="text/javascript",n.setAttribute("charset","UTF-8"),n.async=!0,n.src=c,n.id="LA_COLLECT",i.d=n;var o=function(){s.LA.ids.push(i)};s.LA?s.LA.ids&&o():(s.LA=p,s.LA.ids=[],o()),r.parentNode.insertBefore(n,r)}()}({id:"3JacvsQODVWrNK9p",ck:"3JacvsQODVWrNK9p",autoTrack:true,hashMode:true});
    </script>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip();
        });
    </script>
</head>
<body>
<div class="container-fluid col-xl-8 mt-4">
    <div class="alert alert-danger mt-1" role="alert">
        <a href="https://sunkz.top/posts/文本工具箱上架utools啦/" class="alert-link">工具箱已经上架到 utools 了, 点击查看详情</a>
    </div>
    <div class="row mt-1">
        <div class="col-md-6">
            <textarea id="source" rows="20" class="form-control" placeholder="请输入文本"></textarea>
        </div>
        <div class="col-md-6">
            <textarea id="target" rows="20" class="form-control"></textarea>
        </div>
    </div>
    <div class="btn-group mt-2" role="group" aria-label="Basic example">
        <button type="button" class="btn btn-secondary" data-toggle="tooltip" title="复制结果到输入框" onclick="overwrite()">覆盖</button>
    </div>
    <div class="btn-group mt-2" role="group" aria-label="Basic example">
        <button type="button" class="btn btn-outline-dark" onclick="length()">长度</button>
    </div>
    <div class="btn-group mt-2" role="group" aria-label="Basic example">
        <button type="button" class="btn btn-outline-dark" onclick="reverse()">反转</button>
    </div>
    <div class="btn-group mt-2" role="group" aria-label="Basic example">
        <button type="button" class="btn btn-outline-dark" onclick="calculator()">计算器</button>
    </div>
    <div class="btn-group mt-2" role="group" aria-label="Basic example">
        <button type="button" class="btn btn-outline-dark" onclick="toUpperCase()">转大写</button>
        <button type="button" class="btn btn-outline-dark" onclick="toLowerCase()">转小写</button>
    </div>
    <div class="btn-group mt-2" role="group" aria-label="Basic example">
        <button type="button" class="btn btn-outline-dark" onclick="toCamelCase()">转驼峰</button>
        <button type="button" class="btn btn-outline-dark" onclick="toSnakeCase()">转下划线</button>
    </div>
    <div class="btn-group mt-2" role="group" aria-label="Basic example">
        <button type="button" class="btn btn-outline-dark" onclick="base64Encode()">Base64编码</button>
        <button type="button" class="btn btn-outline-dark" onclick="base64Decode()">Base64解码</button>
    </div>
    <div class="btn-group mt-2" role="group" aria-label="Basic example">
        <button type="button" class="btn btn-outline-dark" onclick="urlEncode()">url编码</button>
        <button type="button" class="btn btn-outline-dark" onclick="urlDecode()">url解码</button>
    </div>
    <div class="btn-group mt-2" role="group" aria-label="Basic example">
        <button type="button" class="btn btn-outline-dark" data-toggle="tooltip" title="各种常见时间格式" onclick="toTimestamp()">转时间戳</button>
        <button type="button" class="btn btn-outline-dark" onclick="toDate()">转日期</button>
    </div>
    <div class="btn-group mt-2" role="group" aria-label="Basic example">
        <button type="button" class="btn btn-secondary disabled">多行</button>
        <button type="button" class="btn btn-outline-dark" onclick="distinct()">去重</button>
        <button type="button" class="btn btn-outline-dark" onclick="ascending()">升序</button>
        <button type="button" class="btn btn-outline-dark" onclick="descending()">降序</button>
        <button type="button" class="btn btn-outline-dark" onclick="mergeDouhao()">合并x,</button>
        <button type="button" class="btn btn-outline-dark" onclick="mergeDanyinhao()">合并'x',</button>
        <button type="button" class="btn btn-outline-dark" onclick="mergeShuangyinhao()">合并"x",</button>
        <button type="button" class="btn btn-outline-dark" onclick="linesCount()">行数</button>
    </div>
    <div class="input-group mt-2">
        <div class="btn-group">
            <button type="button" class="btn btn-secondary disabled">JSON</button>
            <button type="button" class="btn btn-outline-dark" onclick="jsonFold()">压缩</button>
            <button type="button" class="btn btn-outline-dark" onclick="jsonUnfold()">展开</button>
            <button type="button" class="btn btn-outline-dark" onclick="jsonToExcel()">转EXCEL</button>
        </div>

        <div class="custom-file">
            <input type="file" class="custom-file-input" id="file" name="file" accept=".xlsx, .xls" aria-describedby="upload">
            <label class="custom-file-label" for="file" data-browse="EXCEL转JSON" id="fileLabel">请选择EXCEL文件</label>
        </div>
    </div>
    <div class="input-group mt-2">
        <div class="custom-file">
            <input type="file" class="custom-file-input" id="mfile" name="mfile" aria-describedby="upload" accept=".xlsx, .xls" multiple>
            <label class="custom-file-label" for="mfile" data-toggle="tooltip" title="多个相同表头的Excel进行合并" data-browse="EXCEL合并" id="mfileLabel">请选择EXCEL文件</label>
        </div>
    </div>

</div>
<script>
    function overwrite() {
        document.getElementById('source').value = document.getElementById('target').value;
    }

    function mergeDouhao() {
        const lines = document.getElementById('source').value.trim().replace(/,/g, '\n').split('\n').map(item => item.trim()).filter(item => item !== '');
        document.getElementById('target').value = lines.join(',');
    }

    function mergeDanyinhao() {
        const lines = document.getElementById('source').value.trim().replace(/,/g, '\n').split('\n').map(item => item.trim()).filter(item => item !== '');
        document.getElementById('target').value = lines.map(item => `'${item}'`).join(',');
    }

    function mergeShuangyinhao() {
        const lines = document.getElementById('source').value.trim().replace(/,/g, '\n').split('\n').map(item => item.trim()).filter(item => item !== '');
        document.getElementById('target').value = lines.map(item => `"${item}"`).join(',');
    }

    function linesCount() {
        const lines = document.getElementById('source').value.split('\n');
        document.getElementById('target').value = lines.length;
    }

    function distinct() {
        const lines = document.getElementById('source').value.trim().replace(/,/g, '\n').split('\n').map(item => item.trim()).filter(item => item !== '');
        document.getElementById('target').value = [...new Set(lines)].join('\n');
    }

    function ascending() {
        const lines = document.getElementById('source').value.trim().replace(/,/g, '\n').split('\n').map(item => item.trim()).filter(item => item !== '');

        const sortedElements = lines.sort((a, b) => {
            const isNumericA = !isNaN(parseFloat(a)) && isFinite(parseFloat(a));
            const isNumericB = !isNaN(parseFloat(b)) && isFinite(parseFloat(b));

            if (isNumericA && isNumericB) {
                return parseFloat(a) - parseFloat(b);
            } else {
                return a.localeCompare(b);
            }
        });
        document.getElementById('target').value = sortedElements.join('\n');
    }

    function descending() {
        const lines = document.getElementById('source').value.trim().replace(/,/g, '\n').split('\n').map(item => item.trim()).filter(item => item !== '');

        const sortedElements = lines.sort((a, b) => {
            const isNumericA = !isNaN(parseFloat(a)) && isFinite(parseFloat(a));
            const isNumericB = !isNaN(parseFloat(b)) && isFinite(parseFloat(b));

            if (isNumericA && isNumericB) {
                return parseFloat(b) - parseFloat(a);
            } else {
                return b.localeCompare(a);
            }
        });
        document.getElementById('target').value = sortedElements.join('\n');
    }

    function length() {
        document.getElementById("target").value = document.getElementById("source").value.length;
    }

    function reverse() {
        document.getElementById("target").value = document.getElementById("source").value.split('').reverse().join('');
    }

    function toUpperCase() {
        document.getElementById("target").value = document.getElementById("source").value.toUpperCase();
    }

    function toLowerCase() {
        document.getElementById("target").value = document.getElementById("source").value.toLowerCase();
    }

    function toCamelCase() {
        document.getElementById("target").value = document.getElementById("source").value.replace(/(_\w)/g, function (m) {
            return m[1].toUpperCase();
        });
    }

    function toSnakeCase() {
        document.getElementById("target").value = document.getElementById("source").value.replace(/[A-Z]/g, (match) => `_${match.toLowerCase()}`);
    }

    function base64Encode() {
        document.getElementById("target").value = btoa(document.getElementById("source").value);
    }

    function base64Decode() {
        document.getElementById("target").value = atob(document.getElementById("source").value);
    }

    function urlEncode() {
        document.getElementById("target").value = encodeURIComponent(document.getElementById("source").value);
    }

    function urlDecode() {
        document.getElementById("target").value = decodeURIComponent(document.getElementById("source").value);
    }

    function toTimestamp() {
        let dateString = document.getElementById("source").value;
        // 使用正则表达式匹配不同的日期格式
        const regexSimple = /^\d{8}$/;
        if (regexSimple.test(dateString)) {
            const year = dateString.slice(0, 4);
            const month = dateString.slice(4, 6);
            const day = dateString.slice(6, 8);

            const date = new Date(`${year}-${month}-${day}`);
            document.getElementById("target").value = Math.floor(date.getTime() / 1000);
        } else {
            const regex = /(\d{4})[-/年](\d{1,2})[-/月](\d{1,2})(?:日)?(?:\s(\d{1,2}):(\d{1,2}):(\d{1,2}))?/;
            const match = dateString.match(regex);

            if (!match) {
                throw new Error('Invalid date format');
            }

            const [, year, month, day, hour = '00', minute = '00', second = '00'] = match;
            const date = new Date(`${year}-${month}-${day} ${hour}:${minute}:${second}`);

            if (isNaN(date.getTime())) {
                throw new Error('Invalid date');
            }

            document.getElementById("target").value = Math.floor(date.getTime() / 1000);
        }
    }

    function toDate() {
        let timestamp = document.getElementById("source").value;
        const timestampInMilliseconds = timestamp < 10000000000 ? timestamp * 1000 : timestamp;
        const date = new Date(timestampInMilliseconds);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');

        document.getElementById("target").value = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    function calculator() {
        document.getElementById("target").value = eval(document.getElementById("source").value);
    }

    function jsonUnfold() {
        let data = JSON.parse(document.getElementById("source").value);
        document.getElementById("target").value = JSON.stringify(data, null, 4);
    }

    function jsonFold() {
        let data = JSON.parse(document.getElementById("source").value);
        document.getElementById("target").value = JSON.stringify(data, null, 0);
    }

    function s2ab(s) {
        const buf = new ArrayBuffer(s.length);
        const view = new Uint8Array(buf);
        for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }

    function jsonToExcel() {
        const json = document.getElementById("source").value;
        if (!json.startsWith("[")) {
            alert("请输入 JSON 数组");
            return;
        }
        let data = JSON.parse(json);
        let isEleArray = false;
        if (data.length > 0 && typeof data[0] !== "object") {
            let newJsonArray = [];
            for (let i = 0; i < data.length; i++) {
                newJsonArray.push({"key": data[i]});
            }
            data = newJsonArray;
            isEleArray = true;
        }
        const ws = isEleArray ? XLSX.utils.json_to_sheet(data, {skipHeader: true}) : XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        const wbout = XLSX.write(wb, {bookType: 'xlsx', type: 'binary'});
        saveAs(new Blob([s2ab(wbout)], {type: "application/octet-stream"}), 'output.xlsx');
    }

    document.getElementById("file").addEventListener("change", handleFileChange);

    function handleFileChange(event) {
        document.getElementById("fileLabel").innerHTML = event.target.files[0].name;
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = function (e) {
            const data = e.target.result;
            const workbook = XLSX.read(data, {type: 'binary'});
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            let json = XLSX.utils.sheet_to_json(sheet);
            if (json.length > 0 && Object.keys(json[0]).length === 1) {
                const colKey = Object.keys(json[0])[0];
                json.forEach(function (item, index) {
                    json[index] = item[Object.keys(item)[0]];
                });
                if (!isNaN(colKey)) {
                    json.unshift(parseInt(colKey));
                } else {
                    json.unshift(colKey);
                }
            }
            document.getElementById("source").value = JSON.stringify(json, null, 4);
        };
        reader.readAsArrayBuffer(file);
    }

    document.getElementById("mfile").addEventListener("change", handleMFileChange);

    function handleMFileChange(event) {
        document.getElementById("mfileLabel").innerHTML = Array.from(event.target.files).map(file => file.name).join(', ');
        let mergedData = [];
        let allFilesRead = 0;
        const totalFiles = event.target.files.length;

        Array.from(event.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function (e) {
                const data = e.target.result;
                const workbook = XLSX.read(data, {type: 'binary'});
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                let jsonData = XLSX.utils.sheet_to_json(sheet);
                mergedData = mergedData.concat(jsonData);
                allFilesRead++;

                if (allFilesRead === totalFiles) {
                    if (mergedData.length > 0 && Object.keys(mergedData[0]).length === 1) {
                        const colKey = Object.keys(mergedData[0])[0];
                        mergedData.forEach(function (item, index) {
                            mergedData[index] = item[Object.keys(item)[0]];
                        });
                        if (!isNaN(colKey)) {
                            mergedData.unshift(parseInt(colKey));
                        } else {
                            mergedData.unshift(colKey);
                        }
                    }
                    document.getElementById("source").value = JSON.stringify(mergedData, null, 4);

                    // 弹窗提示用户是否保存
                    if (confirm("合并完成，是否保存合并后的 Excel 文件？")) {
                        const ws = XLSX.utils.json_to_sheet(mergedData);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                        const wbout = XLSX.write(wb, {bookType: 'xlsx', type: 'binary'});
                        saveAs(new Blob([s2ab(wbout)], {type: "application/octet-stream"}), 'merged_output.xlsx');
                    }
                }
            };
            reader.readAsArrayBuffer(file);
        });
    }
</script>
</body>
</html>
